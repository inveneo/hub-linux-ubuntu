<!--
 * Asterisk-GUI	-	an Asterisk configuration interface
 *
 * Setup WIzard/ Incoming Calls
 *
 * Copyright (C) 2006-2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * See http://www.asterisk.org for more information about
 * the Asterisk project. Please do not directly contact
 * any of the maintainers of this project for assistance;
 * the project provides a web site, mailing lists and IRC
 * channels for your use.
 *
 * This program is free software, distributed under the terms of
 * the GNU General Public License Version 2. See the LICENSE file
 * at the top of the source tree.
 *
-->
<HTML>
<HEAD>	<TITLE> Asterisk GUI Setup Wizard</TITLE>
	<link href="setup.css" media="all" rel="Stylesheet" type="text/css" />
</HEAD>
<script src="../scripts/prototype.js"></script>
<script src="../scripts/astman.js"></script>
<SCRIPT>

var rawman_url;
var numplan_callbacks = new Object;
var user_callbacks = new Object;
var didtrunks = new Object;
var editstatus ;
var old_incomingrule, old_fromprovider ;
var edit_pattern, edit_DIDtrunk, edit_action, edit_priority ;
var listOfExtensions = [] ;	// to store all the list of extensions to be displayed in the select menu

user_callbacks.format = function(t, x) {
	var tmp = asterisk_guiTDPrefix + t.name ; 
	if ( ( t.fieldbyname['context'] == tmp ) && x == undefined ) {
		didtrunks[tmp] = new Object();
		didtrunks[tmp].trunkname = t.fieldbyname['trunkname'] ; 
		return t.name;
	}
	if (t.fieldbyname['fullname'] && t.fieldbyname['fullname'].length && x == undefined && t.name != "general" ) {
		listOfExtensions.push( t.name + " -- " + t.fieldbyname['fullname'] );
	}
	return false;
}

user_callbacks.loaded = function(){
	parent.astmanEngine.config2list("extensions.conf", _$('extensions'), new Object(), numplan_callbacks);
}
user_callbacks.eachline = true;
user_callbacks.includecats = true;

// parse all contexts in extensions.conf that look like [DID_trunk_x]
// and show each entry in the table
numplan_callbacks.format = function(t, x) {
	if ((t.name == specialcontext && x != undefined )){
		var p = format_extension( _$('extensions'), t, x)  ;
		if ( p != null ){ listOfExtensions.push(p); }
	}
	if ( ( t.name.substring(0,asterisk_guiTDPrefix.length) == asterisk_guiTDPrefix ) && x == undefined){
		if(typeof didtrunks[t.name] == "undefined"){
			didtrunks[t.name] = new Object();
			didtrunks[t.name].trunkname = t.name;
		}
		return t.name;
	}
	if ( ( t.name.substring(0,asterisk_guiTDPrefix.length) == asterisk_guiTDPrefix ) && t.names[x]=='exten' ){
		//get pattern & action
		var temp = t.fields[x].split(',');
		if( temp[0] == "s" ){return false;}
		didtrunks[t.name][temp[0]] = new Object();
		didtrunks[t.name][temp[0]].priority = temp[1];
		didtrunks[t.name][temp[0]].action = temp[2];
	}
	return false;
}

numplan_callbacks.loaded = function() {
	listOfExtensions.sort();
	for(var a =0; a < listOfExtensions.length ; a++ ){
		var b = listOfExtensions[a].split(' -- ');
		var New_OPTION = document.createElement('option');
		New_OPTION.text = listOfExtensions[a] ;
		New_OPTION.value = b[0] ;
		try {
			_$('toextension').add(New_OPTION, null); // W3C way
		}catch(ex) {
			_$('toextension').add(New_OPTION); // IE way
		}
	}

	// load list of trunks to 'fromprovider'
	var t ;
	for ( t in didtrunks){	if(  didtrunks.hasOwnProperty(t) ){
		var a = document.createElement('option');
		a.text = didtrunks[t].trunkname ;
		a.value = t ;
		var b = document.getElementById('fromprovider');
		try {
			b.add(a, null); 
		}catch(ex) {
			b.add(a); 
		}
	}}
	// load the object didtrunks into the table callingRulesTable
	refreshtable();
}

numplan_callbacks.eachline = true;
numplan_callbacks.includecats = true;

function refreshtable(){
	for( var i=0; i <  _$('callingRulesTable').rows.length; ){
		_$('callingRulesTable').deleteRow(i);
	}
	
	for ( var i in didtrunks ){ // for each trunk
		if( didtrunks.hasOwnProperty(i) ){ 
			for(var j in didtrunks[i]){ // for each pattern of the trunk
				if( didtrunks[i].hasOwnProperty(j) ){ 
					if( j == "trunkname"){ continue;}
					addrowtotable( j, i, didtrunks[i][j].action, didtrunks[i][j].priority);
				}
			}
		}
	}

	if( _$('callingRulesTable').rows.length == 0){
		_$('table_one').style.display="none";
		var newRow = _$('callingRulesTable').insertRow(-1);
		var newCell0 = newRow.insertCell(0);
		newCell0 .align = "center";
		newCell0 .style.fontSize = "14px";
		newCell0 .innerHTML = "<BR>An <I>incoming Calling Rule</I> is not defined<BR><BR> Please click on 'Add a Incoming Rule' button<BR> to add a new incoming call rule.<BR><BR>" ;
		return true;
	}

}

function addrowtotable(a,b,c,d){	// a is pattern, b is DID_trunk, c is action, d is priority
	var sno = _$('callingRulesTable').rows.length + 1;
	var newRow = _$('callingRulesTable').insertRow(-1);
	newRow.id = "row" + sno; 

	var newCell0 = newRow.insertCell(0);
	newCell0.innerHTML = sno ;
	newCell0.align="center";
	newCell0.width=35;
	newCell0.style.fontSize = "12px";

	var newCell1 = newRow.insertCell(1);
	newCell1.innerHTML =  convert_tohuman(a,b,c) ;
	newCell1.style.fontSize = "12px"; 

	var newCell2 = newRow.insertCell(2);
	newCell2.innerHTML = "<A href=\"#\" onclick=\"edit_incomingrule('"+ a +"', '"+ b +"', '" + c + "','" + d+"')\">Edit</A>&nbsp;&nbsp;<A href=\"#\" onclick=\"delete_incomingrule('"+ a +"', '"+ b +"', '" + c + "','" + d+"')\">Delete</A>";
	newCell2.width=75;
	newCell2.align="center";
	newCell2.style.fontSize = "12px";
	return true;
}


function convert_tohuman(a,b,c) { // a is pattern, b is DID_trunk, c is action, 
	var trunk = b.substr(4) ;
	if( c.match("Goto") && !c.match("voicemenu-")  ){ 
		var tmp = c.split('(');
		var exten = tmp[1].split('|'); // extension is exten[1]
	}

	if( a == "_X."){ // handling all unmatched 
		return " Route all unmatched incoming calls from provider '" + didtrunks[b].trunkname + "' to extension '" + exten[1] + "'" ; 
	}
	return " Route incoming calls from provider '" + didtrunks[b].trunkname + "' that match pattern '" + a + "' to extension '" + exten[1] + "'"  ; 
}


function add_incomingrule(){
	editstatus = "NEW";
	_$('incomingrule').selectedIndex = 0;
	_$('fromprovider').selectedIndex = -1;
	old_incomingrule = "allunmatched";
	old_fromprovider = "";
	_$('toextension').selectedIndex = -1;
	_$('frompattern').value = "";
	_$('save_a').disabled = true;
	_$('thatmatch').style.display = "none" ;
	_$('userscontent').style.display = "";
	_$('bg_transparent').style.display = "";
}

function edit_incomingrule(a,b,c,d){// a is pattern, b is DID_trunk, c is action, d is priority
	edit_pattern = a; 
	edit_DIDtrunk = b;
	edit_action = c; 
	edit_priority=d ;

	editstatus = "EDIT";
	if(a == "_X."){
		_$('incomingrule').selectedIndex = 0;
		_$('thatmatch').style.display = "none" ;
		old_incomingrule = "allunmatched";
	}else{
		_$('frompattern').value = a ;
		_$('incomingrule').selectedIndex = 1;
		_$('thatmatch').style.display = "" ;
		old_incomingrule = "frompattern";
	}

	for(var i=0; i < _$('fromprovider').length ; i++){
		if( _$('fromprovider').options[i].value == b){
			_$('fromprovider').selectedIndex = i;		
			old_fromprovider = b;
			break;
		}
	}

	if( c.match("Goto") && !c.match("voicemenu-")  ){ 
		var tmp = c.split('(');
		var exten = tmp[1].split('|'); // extension is exten[1]
		_$('toextension').selectedIndex = -1 ;
		for(var t=0; t < _$('toextension').length ; t++ ){
			if( _$('toextension').options[t].value == exten[1] ){
				_$('toextension').selectedIndex = t;
				break;
			}
		}
	}

	_$('userscontent').style.display = "";
	_$('bg_transparent').style.display ='';
}


function save_incomingrule(){
	if(	editstatus == "NEW"){
		save_new_incomingrule();
	}else if ( editstatus == "EDIT" ){
		update_incomingrule();
	}
}


function save_new_incomingrule(){
	// field validation 
	if(_$('incomingrule').value == "frompattern" && _$('frompattern').value == "" ){
		alert("Please define an incoming call pattern !");
		_$('frompattern').focus();
		_$('frompattern').select();
		return false;
	}
	if( _$('fromprovider').selectedIndex == -1 ){
		alert("Please select a service provider !");
		_$('fromprovider').focus();
		return false;
	}
	if( _$('toextension').selectedIndex == -1 ){
		alert("Please select an extension to which an incoming call should be routed to !");
		_$('toextension').focus();
		return false;
	}

	if(_$('incomingrule').value == "frompattern" && _$('frompattern').value.substr(0,1) != "_" ){
				$('frompattern').value = "_" + _$('frompattern').value ;
	}

	// create an entry under the selected trunk
	// $('incomingrule') == "allunmatched" or "frompattern" , $('frompattern'), $('fromprovider'), $('toextension')
	if (_$('incomingrule').value == "allunmatched" ){
		var newpattern = "_X." ;
		var temp_provider = _$('fromprovider').value;
		var temp_priority = "1";
		var temp_action = "Goto(default|" + _$('toextension').value + "|1)";
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		var new_exten2 = "s,1," + temp_action;
		var uri = build_action('append', 0, temp_provider ,"exten", new_exten);
		uri += build_action('append', 1, temp_provider ,"exten", new_exten2);
	}else{
		var newpattern = _$('frompattern').value ;
		var temp_provider = _$('fromprovider').value ;
		var temp_action = "Goto(default|" + _$('toextension').value + "|1)";
		var temp_priority = "1";
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		var uri = build_action('append', 0, temp_provider ,"exten", new_exten ); 
	}

	// check whether there is an existing entry with this pattern 
	if( typeof didtrunks[temp_provider][newpattern] != "undefined" ){
		alert("An incoming call rule is already defined \n on this trunk for the selcted pattern !! ");
		return false;
	}
	
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 									
			// add this to the global object
			didtrunks[temp_provider][newpattern] = new Object();
			didtrunks[temp_provider][newpattern].priority = temp_priority;
			didtrunks[temp_provider][newpattern].action = temp_action ;
			//addrowtotable(newpattern,temp_provider,temp_action,temp_priority) ; // a is pattern, b is DID_trunk, c is action, d is priority
			refreshtable();
			_$('userscontent').style.display = "none";
			_$('bg_transparent').style.display ='none';
		},
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};

	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(rawman_url, opt);
	// 
}


function update_incomingrule(){
	// field validation 
	if(_$('incomingrule').value == "frompattern" && _$('frompattern').value == "" ){
		alert("Please define an incoming call pattern !");
		_$('frompattern').focus();
		_$('frompattern').select();
		return false;
	}
	if( _$('toextension').selectedIndex == -1 ){
		alert("Please select an extension to which an incoming call should be routed to !");
		_$('toextension').focus();
		return false;
	}

	if( _$('incomingrule').value == "frompattern" && _$('frompattern').value.substr(0,1) != "_" ){
		_$('frompattern').value = "_" + _$('frompattern').value ;
	}
	// old values before editing are - edit_pattern, edit_DIDtrunk, edit_action, edit_priority
	// check for duplicate other than old
	var p = 0 ;
	var uri = "" ;
	var temp_provider = _$('fromprovider').value ;
	var temp_action = "Goto(default|" + _$('toextension').value + "|1)";
	var temp_priority = "1";
	var tmp_old_string = edit_pattern  + "," + edit_priority + "," + edit_action;
	uri += build_action('delete', p, edit_DIDtrunk ,"exten", "", tmp_old_string); p++;
	if(edit_pattern == "_X." ){
		var tmp2_old_string = "s," + edit_priority + "," + edit_action ;
		uri += build_action('delete', p, edit_DIDtrunk ,"exten", "", tmp2_old_string); p++;
	}

	if ( _$('incomingrule').value == "allunmatched" ){
		var newpattern = "_X." ;
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		var new_exten2 = "s," + temp_priority + "," + temp_action;
		uri += build_action('append', p , temp_provider ,"exten", new_exten ); p++ ;
		uri += build_action('append', p , temp_provider ,"exten", new_exten2 ); p++ ;
	}else{
		var newpattern = _$('frompattern').value ;
		var new_exten = newpattern  + "," + temp_priority + "," + temp_action;
		uri += build_action('append', p , temp_provider ,"exten", new_exten ); p++ ;
	}

	if( typeof didtrunks[temp_provider][newpattern] != "undefined" && ( temp_provider != edit_DIDtrunk || newpattern != edit_pattern ) ){
		alert("An incoming call rule is already defined \n on this trunk for the selcted pattern !! ");
		return false;
	}

	// delete old entry and add new entry
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) { 									
			delete didtrunks[edit_DIDtrunk][edit_pattern] ;
			didtrunks[temp_provider][newpattern] = new Object();
			didtrunks[temp_provider][newpattern].priority = temp_priority;
			didtrunks[temp_provider][newpattern].action = temp_action ;
			_$('userscontent').style.display = "none";
			_$('bg_transparent').style.display ='none';
			refreshtable();
		},
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(rawman_url, opt);

}

function checksave(k){
	if( old_incomingrule == _$('incomingrule').value && old_fromprovider == _$('fromprovider').value ){
		return true;
	}

	if(_$('incomingrule').value == "frompattern" ){
		_$('thatmatch').style.display = "" ;
		if(k.id=="incomingrule"){
			_$('frompattern').focus();
			_$('frompattern').select();
		}
	}else{
		_$('thatmatch').style.display = "none" ;
	}

	_$('save_a').disabled = false;
	old_incomingrule = _$('incomingrule').value ;
	old_fromprovider = _$('fromprovider').value ;
}


function enablesave(){
	_$('save_a').disabled = false;
}

function delete_incomingrule(a,b,c,d){ // a is pattern, b is DID_trunk, c is action, d is priority
	t=confirm("Are you sure you want to delete this Incoming Calling Rule?");
	if(t == false){ 
		return true;
	}

	var tmp_match = a+","+d+","+c ;
	var opt = {
		method: 'get',
		asynchronous: true,
		onSuccess: function(t) {
			// add this to the global object
			delete didtrunks[b][a];
			refreshtable();
		},
		onFailure: function(t) {
			alert("Config Error: " + t.status + ": " + t.statusText);
		}
	};
	var uri = build_action('delete',0, b, "exten" ,"", tmp_match);
	if( a == "_X." ){
		var tmp2_match = "s," + d + "," + c ;
		uri += build_action('delete',1,b,"exten","", tmp2_match);
	}
	opt.parameters="action=updateconfig&srcfilename=" + encodeURIComponent("extensions.conf") + "&dstfilename=" + encodeURIComponent("extensions.conf") + uri;
	var tmp = new Ajax.Request(rawman_url, opt);
}



function localinit(){
	parent._$('next').onclick = function(){	 window.location.href="10.html"; };
	parent._$('back').onclick  = function(){ window.location.href="7.html"; };
	rawman_url = parent.rawman_url ;
	parent.astmanEngine.setURL(rawman_url);
	ping();
}

function ping(){
	var opt = { method: 'get', asynchronous: true, onComplete: isloggedin };
	opt.parameters="action=ping" ;
	var tmp = new Ajax.Request(rawman_url , opt);
}

function isloggedin(originalRequest){
	if ( originalRequest.responseText.match("Error") ) {
		// User is not logged in , show him the login screen
		parent.window.location.href = parent.window.location.href ; 
	}

	if ( originalRequest.responseText.match("Pong") ) {
		showdiv_statusmessage();
		setWindowTitle("Incoming Calls");
		parent.astmanEngine.config2list("users.conf", _$('users'), new Array(), user_callbacks);
	}
}

</SCRIPT>
<BODY bgcolor="#FFFFFF" onload="localinit()" topmargin=0 leftmargin=0>
<table width="100%" height="100%" border=0 cellpadding=0 cellspacing=0>
<tr>	
<td width="170" valign=top align=left>
<div id="menu">
<table cellpadding=3 cellspacing=2 border=0 id="sidelist">
	<tr><td width=3></td><td>Start</td></tr>
	<tr><td></td><td>Verify Analog Ports</td></tr>
	<!-- <tr><td></td><td>Date & Time</td></tr> -->
	<tr><td></td><td>Local Extension Settings</td></tr>
	<tr><td></td><td>Service Providers</td></tr>
	<tr><td></td><td>Calling Rules</td></tr>
	<tr><td></td><td>VoiceMail Settings</td></tr>
	<tr><td></td><td>User Extensions</td></tr>
	<tr><td></td><td class="slselected">Incoming Calls</td></tr>
	<!-- <tr><td></td><td>VoiceMenus</td></tr> -->
	<tr><td></td><td>Finish</td></tr>
</table>
</div>
</td>
<td valign=top align=center>
<!--  this page -->
	<select id="extensions" style="display:none"></select>
	<select id="users" style="display:none"></select>

	<div class="heading">
		Step 7 of <script>document.write(parent.numberofsteps);</script>&nbsp;&nbsp;-  Incoming Calls
	</div>

	<div class="subheading">List of incoming call rules</div>

	<table class="table_blacksm" cellpadding=2 cellspacing=2 border=0 align=center width=500 id="table_one">
	<tr>	<td width=35>S.No</td>
		<td> Incoming Rule </td>
		<td width=75 align=center>Options</td>
	</tr>
	</table>

	<div id="callingRulesTable_div" style="height:200px;width=100%; overflow :auto; padding : 0px 0px 0px 0px;">
		<table id="callingRulesTable" cellpadding=2 cellspacing=1 border=0 align=center width=500></table>
	</div>

	<BR>
	<center><input type="button" id="adddid" value="Add a Incoming Rule" onclick="add_incomingrule();"></center>
	<div id="userscontent" STYLE="display:none; position: absolute; left: 227; top: 70; width:475; height:190;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid;z-index:5">
		<table width="100%" cellpadding=0 cellspacing=0 onmousedown="ASTGUI.startDrag(event , 'userscontent');">
		<TR bgcolor="#7E5538"  style="background-image:url('../images/title_gradient.gif');">
			<TD Height="20" align="right" style="cursor: move">
				<A href="#" onclick="$('cancel_a').click();"><font style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</font></A>
			</TD>
			<TD width=4></TD>
		</TR>
		</table>
	
		<TABLE align=center cellpadding=2 cellspacing=2 border=0 width="100%">
		<TR>	<TD height=10></TD></TR>
		<TR>	<TD align=center>
			<NOBR>Route <select id="incomingrule"  onclick="checksave(this)" class="input9">
				<option value="allunmatched">All Unmatched incoming calls</option>
				<option value="frompattern">incoming calls that match </option>
				</select>
				<span id="thatmatch">pattern <input type="text" id="frompattern" size=12  onchange="enablesave();"  onkeyup="enablesave();"  class="input9"></span>
			</NOBR>
			</TD>
		</TR>
		<TR>	<TD align=center>from provider <select id="fromprovider" onclick="checksave(this)"  class="input9"></select>	</TD></TR>
		<TR>	<TD align=center>to extension <select id="toextension" onchange="enablesave();"  onkeyup="enablesave();"  class="input9"></select></TD>
		</TR>
		<TR>	<TD align=center height=50 valign=middle>  
				<input type="button" id="save_a" value="Save" onclick="save_incomingrule();">&nbsp;&nbsp;
				<input type="button" id="cancel_a" value="Cancel" onclick="$('userscontent').style.display='none'; $('bg_transparent').style.display ='none';" >
			</TD>
		</TR>
		</TABLE>
	</div>
	<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 0; width:100%; height:100%;  background-color:#EFEFEF; -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #EFEFEF; border-style: solid; z-index:4">
	</div>
<!--  this page -->
</td>
</tr>
</table>
</div>
</BODY>
</HTML>