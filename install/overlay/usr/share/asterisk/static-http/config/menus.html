<!--
 * Configuration for IVR (Interactive Voice Menus)
 *
 * Copyright (C) 2006 - 2007, Digium, Inc.
 *
 * Mark Spencer <markster@digium.com>
 * Pari Nannapaneni <pari@digium.com>
 *
 * All Rights Reserved.
 *
 * Distribution of this file is subject to the license
 * agreement you accepted when obtained and/or activated
 * the Digium product containing this file.
 *
-->
<script src="scripts/prototype.js"></script>
<script src="scripts/astman.js"></script>
<script src="scripts/tooltip.js"></script>
<link href="stylesheets/schwing.css" media="all" rel="Stylesheet" type="text/css" />
<style type="text/css">
	.page_header {
		font-size : 12px;
		padding : 4px 6px 4px 6px;
		border-style : solid none solid none;
		border-top-color : #BDC7E7;
		border-bottom-color : #182052;
		border-width : 1px 0px 1px 0px;
		background-color : #ef8700;
		margin-bottom: 10px;
		color : #ffffff;
	}

	.VoiceMenuMainTable{
		border : 0;
		width	: 750px; 
		font-size: 11px;
	}
</style>
<script>
var widgets = {};
var adstatus;
var menuscallbacks = new Object;
var extencallbacks = new Object;
var usercallbacks = new Object;
var numcallbacks = new Object;
var fieldnames = new Array('delete', 'new','save','cancel');
var voicemenusdata = new Object;
var current_context;
var keys = new Array('0','1','2','3','4','5','6','7','8','9','*','#','t','i');
var extensions_array = new Array;
var answer_call_string = "s,1,Answer";
var localextenlength ;
var LISTOFSOUNDS = [];

function format_step(this_step){
	var temp = this_step.split(',');

	if( temp[2].match("Goto") && this_step.match(TIMERULES_CATEGORY)  ){
		var tmp = this_step.split('Goto')[1].substr(1);
		tmp = tmp.substr(0, tmp.length-1);

		var m = _$('tbr');
		for(var l=0; l < m.options.length; l++ ){
			if(m.options[l].value == tmp){ return "Goto TimeBasedRule '"+  m.options[l].text + "'"; }
		}
		return "Goto '"+  tmp + "' (NOT FOUND)";
	}

	if( temp[2].match("Goto") && this_step.match('ringroups-custom-')  ){
		var tmp = this_step.split('Goto')[1].substr(1);
		tmp = tmp.substr(0, tmp.length-1);

		var m = _$('rgrp');
		for(var l=0; l < m.options.length; l++ ){
			if(m.options[l].value == tmp){ return "Goto RingGroup '"+  m.options[l].text + "'"; }
		}
		return "Goto '"+  tmp + "' (NOT FOUND)";
	}

	if( temp[2].match("Answer") )
		return "Answer the Call";
	if( temp[2].match("Authenticate") ){
		// Background('') - whatever in the brackets
		temp[2] = temp[2].replace(/Authenticate\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Authenticate for Password '" + temp[2] + "'";
	}
	if( temp[2].match("DISA") ){
		// Background('') - whatever in the brackets
		temp[2] = temp[2].replace(/DISA\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "DISA ***********";
	}
	if( temp[2].match("Background") ){
		// Background('') - whatever in the brackets
		temp[2] = temp[2].replace(/Background\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Play '" + temp[2] + "' & Listen for KeyPress";
	}
	if( temp[2].match("TIMEOUT") && temp[2].match("digit") ){
		temp[2] = temp[2].replace(/Set\(TIMEOUT\(digit\)\=/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Wait '"+ temp[2] +"' sec for KeyPress";
	}
	if( temp[2].match("TIMEOUT") && temp[2].match("response") ){
		temp[2] = temp[2].replace(/Set\(TIMEOUT\(response\)\=/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Response Timeout to '" + temp[2] + "' sec";
	}
	if( temp[2].match("Playback") ){
		temp[2] = temp[2].replace(/Playback\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Play '" + temp[2] + "' & Donot Listen for KeyPress";
	}
	if( temp[2].match("WaitExten") ){
		temp[2] = temp[2].replace(/WaitExten\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "WaitExten '"+ temp[2] + "' sec";
	}else if( temp[2].match("Wait") ){
		temp[2] = temp[2].replace(/Wait\(/, "");
		temp[2] = temp[2].replace(/\)/, "");
		return "Wait '"+ temp[2] + "' sec";
	}

	if( temp[2].match("Goto") && temp[2].match("voicemenu-")  ){
		var tmp = temp[2].split('(');
		var tmp1 = tmp[1].split('|');
		try{
			return "Goto Menu '"+  voicemenusdata[tmp1[0]].comment  + "'";
		}
		catch(e){
			return "Goto Menu '"+  tmp1[0] + "'";
		}
	}

	if( temp[2].match("Goto") && !temp[2].match("voicemenu-")  ){
		var tmp = temp[2].split('(');
		var tmp1 = tmp[1].split('|');
		if( tmp1[1] == 'o' ){return "Goto 'Operator'";}
		return "Goto Exten '"+ tmp1[1] + "'";
	}

	if( temp[2].match("VoiceMailMain") && temp[2].match("CALLERID")  ){
		return "Check VoiceMail for own Extension";
	}
	
	if( temp[2].match("Hangup") )
		return "Hangup";

	if( temp[2].match("Busy") )
		return "Busy Tone";

	if( temp[2].match("Congestion") )
		return "Congestion";

	if( temp[2].match("Directory") && temp[2].match("default"))
		return "Goto Directory";

 return this_step;
}

function load_extensions(my_field_options){
	var _mo = _$(my_field_options); 
	_mo.options.length=0;
	for(var x=0; x < extensions_array.length; x++){
		var newoption = document.createElement("option"); 
		newoption.text = extensions_array[x] ; 
		newoption.value = extensions_array[x] ;
		if(extensions_array[x] == 'o'){ newoption.text = "Operator" ; }
		_mo.options.add(newoption);
	}
}

function load_menus(my_field_options){
	var _mo = _$(my_field_options) ;
	var _vms = _$('vmenus') ;
	_mo.options.length=0;
	
	for(var x=0; x < _vms.length; x++){
		if( _vms.options[x].text == "New Entry" ){ continue ; }
		var newoption = document.createElement("option"); 
		newoption.text = voicemenusdata[ _vms.options[x].value].comment ; 
		newoption.value = _vms.options[x].value ;
		_mo.options.add(newoption);
	}
}

function select_menu (my_field_options, menustring, a){
	var tmp = menustring.split('(');
	var tmp1 = tmp[1].split('|');
	var _mfo = _$(my_field_options) ;

	if(a == "ismenu"){
		var check_against = tmp1[0]; 
	}else if(a == "isext"){ 
		var check_against = tmp1[1] ;
	}

	for(var y=0; y < _mfo.options.length; y++ ){
		if( _mfo.options[y].value == check_against ){
			_mfo.options[y].selected = true;
			return true;
		}
	}
	// if not in the current list of voicemenus/extensions then add it to the menu
	var newoption = document.createElement("option"); 
	newoption.text = check_against ; 
	newoption.value = check_against ;
	_mfo.options.add(newoption);
	_mfo.options[y].style.fontWeight = 'bold';
	_mfo.options[y].selected = true;
	_mfo.style.color = '#CC0000';
}

function add_newvmenu_tolistofkeymenus(){
	var _vms = _$('vmenus') ;
	var _vmsv = _vms.options[_vms.selectedIndex].value ;
	var _cv = _$('comment').value ;
	for (var k=0; k< keys.length; k++){
		var current_key_menus='keypress_'+ keys[k] + '_menus';
		var newoption = document.createElement("option"); 
		newoption.text = _cv ; 
		newoption.value = _vmsv ;
		_$(current_key_menus).options.add(newoption);
	}
	// and also add it to $('add_newstep_menus')
	var newoption = document.createElement("option"); 
	newoption.text = _cv ; 
	newoption.value = _vmsv ;
	_$('add_newstep_menus').options.add(newoption);
}


function delete_vmenu_fromlistofmenus(){
	var _cv = _$('comment').value ;
	for (var k=0; k< keys.length; k++){
		var current_key_menus='keypress_'+ keys[k] + '_menus';
		var _ckm = _$(current_key_menus);

		for(var i=0; i< _ckm.options.length; i++){
			if( _ckm.options[i].text == _cv ){
				// delete this option from the $(current_key_menus)
				var deleted_voicmenu = _ckm.options[i].value ;
				_ckm.remove(i);
				break;
			}
		}
	}
	var _anm = _$('add_newstep_menus') ;
	for(var i=0; i< _anm.options.length; i++){
		if( _anm.options[i].text == _cv ){
			_anm.remove(i);
			break;
		}
	}
	// use the deleted_voicmenu to delete the alias (if it exists) in the default
	if(_$('alias_exten').value.length > 0){
		var existing_alias_string = voicemenusdata[deleted_voicmenu].alias_exten + ",1,Goto(" + deleted_voicmenu + "|s|1)"  ;
		var uri = build_action('delete', 0, specialcontext ,"exten", "", existing_alias_string ); 
		makerequest('u','extensions.conf', uri, function(t){ } );
	}
	delete voicemenusdata[deleted_voicmenu];
}


function change_vmenuname_inlistofmenus(oldname,newname){
	for (var k=0; k< keys.length; k++){
		var current_key_menus='keypress_'+ keys[k] + '_menus';
		var _ckm = _$(current_key_menus) ;
		for(var i=0; i< _ckm.options.length; i++){
			if( _ckm.options[i].text == oldname ){
				_ckm.options[i].text = newname;
				break;
			}
		}
	}
}


function  key_action(a, field){
	enable_savecancel();

	_mft = _$('keypress_'+ field + '_text' );
	_mfe = _$('keypress_'+ field + '_exts').style;
	_mfm = _$('keypress_'+ field + '_menus').style
	_mft.style.display = "none";
	_mfe.display = "none";
	_mfm.display = "none";

	if(a=='gotomenu'){ //show menus dropdown
		_mfm.display = "";
	}else if(a=='gotoextension'){ //show extensions dropdown
		_mfe.display = "";
	}else if(a=='Custom'){ //show a  text box
		_mft.style.display = "";
		_mft.focus();
	}else if(a=='disabled' || a=='Hangup' || a=='PlayInvalid'){	//show nothing

	}
}

function sortNumber(a,b){
	return a - b ;
}


function add_newstep(){
	var _vmv = _$('vmenus').value ;
	var _nsa = _$('newstep_action');
	var _nsv = _$('newstep_var') ;
	var _nss = _$('newstep_sounds');

	if( !_nsa.value ){
		gui_alert("Please select an action for this step");
		_nsa.focus();
		return;
	}

	if( _nsa.value== "Background"  || _nsa.value== "Playback" ){
		_nsv.value = _nss.value;
	}

	if( _nsa.value != "Answer" && _nsa.value != "GotoDirecotry" && _nsa.value !="CheckOwnVoiceMail" && _nsa.value != "Busy" && _nsa.value != "Hangup" && _nsa.value != "Congestion" && !_nsv .value ){
		
		if( _nsa.value.toLowerCase() == "dialringgroup" ){
			if(!_$('rgrp').options.length ){
				gui_alert("No Ring Groups exist. <BR> Please create a Ring Group before selecting this option.");
			}else{
				gui_alert("Please select a RingGroup");
			}
			return;
		}

		gui_alert("Please enter a value for '" + _nsa.value +"'");
		_nsv.focus();
		return;
	}
	_$('status_message').style.display = "";
	// prepare a request to add the new step to the voicemenu
	// make a request to append

	var uri = "";
	var action_string = "";
	var priorities = new Array;

	if(voicemenusdata[_vmv].extensions['s'] && voicemenusdata[_vmv].extensions['s'].length > 0 ){
		// you might be tempted to say " newpriority = voicemenusdata[_vmv].extensions['s'].length + 1; " but this won't work cause 
		// you might be dealing a "[s,1][s,3][s,7]"  where the array length is 3 - but new priority shud be 8

		// so ,
		var laststep_tmp = voicemenusdata[_vmv].extensions['s'][ voicemenusdata[_vmv].extensions['s'].length -1 ] ;
		var laststep_priority = ASTGUI.parseContextLine.getPriority( laststep_tmp );

		// gui versions before AA50 firmware 1.1 used 's,n'
		// this is updated to's,number' in 1.1
		// so if we find a old format - we will delete all the 's' extension and update it to new format
		newpriority = ( laststep_priority == 'n' ) ? voicemenusdata[_vmv].extensions['s'].length + 1 : Number(laststep_priority) + 1 ;
	}else{
		newpriority = 1;
	}

	switch ( _nsa.value ){
	case 'Answer':
		action_string = "s,"+ newpriority+ ",Answer";
		break;
	case 'Authenticate':
		action_string = "s,"+ newpriority+ ",Authenticate(" + _nsv.value + ")";
		break;
	case 'DISA':
		action_string = "s,"+ newpriority+ ",DISA(" + _nsv.value + ")";
		break;
	case 'Background':
		action_string = "s,"+ newpriority+ ",Background(" + _nsv.value + ")";
		break;
	case 'Busy':
		action_string = "s,"+ newpriority+ ",Busy";
		break;
	case 'Congestion':
		action_string = "s,"+ newpriority+ ",Congestion";
		break;
	case 'DigitTimeout':
		action_string = "s,"+ newpriority+ ",Set(TIMEOUT(digit)=" + _nsv.value + ")";
		break;
	case 'ResponseTimeout':
		action_string = "s,"+ newpriority+ ",Set(TIMEOUT(response)=" + _nsv.value + ")";
		break;
	case 'Playback':
		action_string = "s,"+ newpriority+ ",Playback(" + _nsv.value + ")";
		break;
	case 'Wait':
		action_string = "s,"+ newpriority+ ",Wait(" + _nsv.value + ")";
		break;
	case 'WaitExten':
		action_string = "s,"+ newpriority+ ",WaitExten(" + _nsv.value + ")";
		break;
	case 'GotoMenu':
		action_string = "s,"+ newpriority+ ",Goto(" + _nsv.value + "|s|1)";
		break;
	case 'GotoExtension':
		action_string = "s,"+ newpriority+ ",Goto(default|" + _nsv.value + "|1)";
		break;
	case 'GotoTimeBasedRule':
		//action_string = "s,"+ newpriority+ ",Goto(" + _$('tbr').value + ")";
		break;
	case 'DialRingGroup':
		action_string = "s,"+ newpriority+ ",Goto(" + _$('rgrp').value + ")";
		break;
	case 'Hangup':
		action_string = "s,"+ newpriority+ ",Hangup";
		break;
	case 'GotoDirecotry':
		action_string = "s,"+ newpriority+ ",Directory(default|" + _vmv + "||)";
		break;
	case 'CheckOwnVoiceMail':
		action_string = "s,"+ newpriority+ ",VoiceMailMain(${CALLERID(num)}@default)" ;
		break;
	default : 
		action_string = "s,undefined,undefined"; 
	}

	var after = function(t){
		setTimeout(function(){ _$('status_message').style.display = 'none'; },sc_displaytime);
		hide_addStep();
		// if request successfull then add this to the steps select box
		var newoption = document.createElement("option"); 
		newoption.text = format_step(action_string ); 
		newoption.value = action_string ;
		var _steps = _$('steps') ;
		_steps.options.add ( newoption );
		// and also add the information to the voicemenus data
		if(voicemenusdata[_vmv].extensions['s']){
			voicemenusdata[_vmv].extensions['s'].push(action_string);
		}else{
			voicemenusdata[_vmv].extensions['s'] = new Array;
			voicemenusdata[_vmv].extensions['s'][0] = action_string;
		}
		// empty this textbox & disable this button, select the newly added item to the steps options box
		_nsa.selectedIndex = 0;
		_$('deletestep').disabled = false;
		_steps.selectedIndex = _steps.length - 1 ;
		gui_feedback('New step added !','blue');
		update_updown();
		_nsv.value = "";
		_nss.value="";
		_nsv.style.display = "none" ;
		_nss.style.display = "none" ;
		_$('add_newstep_extensions').style.display = "none";
		_$('add_newstep_menus').style.display = "none";
		_nsvd = _$('newstep_var_digit'); 
		_nsvd.value= "";
		_nsvd.style.display= "none" ;
		if(laststep_priority == 'n' ){ window.location.reload(); }
	}

	if( laststep_priority=='n' ){ // if old configuration - update to new 
		var chs = new listOfActions(); 
		chs.filename('extensions.conf'); var c = 0;
		for(var vg=0; vg < voicemenusdata[_vmv]['extensions']['s'].length ; vg++ ){
			chs.build_action ( 'delete', c , _vmv, "exten", '', voicemenusdata[_vmv]['extensions']['s'][vg] );
		}

		var tmp_priority = 1;
		for(var vg=0; vg < voicemenusdata[_vmv]['extensions']['s'].length ; vg++ ){
			var tmp_step = 's,' + tmp_priority + ','+ ASTGUI.parseContextLine.getAction( voicemenusdata[_vmv]['extensions']['s'][vg] ) ;
			voicemenusdata[_vmv]['extensions']['s'][vg] = tmp_step;
			tmp_priority++ ;
			chs.build_action ( 'append', c , _vmv, 'exten', tmp_step );
		}
		chs.build_action( 'append', c , _vmv, 'exten', action_string );
		chs.callActions(after);
		return;
	}else{
		uri += build_action('append', 0, _vmv,"exten", action_string ); 
		makerequest('u','extensions.conf', uri, after );
		return;
	}

}



function next_freevmenu(){	 // return the next smallest available voicemenu name
	var x=1;
	while(typeof voicemenusdata['voicemenu-custom-'+x] != 'undefined' ) x++;
	return 'voicemenu-custom-'+x ;
}


function save_vmenu(){
	var _ae = _$('alias_exten') ;
	var _vms = _$('vmenus') ;
	var _ale = _$('allowexten');

	if( _ae.value.length > 0 && localextenlength !=0 && localextenlength !=  _ae.value.length){
		gui_alert("Sorry, An Extension must be  "+ localextenlength  + " digits !");
		_ae.focus();
		return false;
	}
	if (!check_patternonfields( [ 'comment', 'newstep_var_digit' ] ) ){
		return false;
	}
	_$('status_message').style.display ="" ;
	var _cmv = _$('comment').value ;
	var uri = "" ;
	var p = 0 ;
	var buildstring = new Object ;

	if( _vms.options[_vms.selectedIndex].innerHTML=='New Entry' ){
		var current_vmenu = next_freevmenu();
		uri += build_action('newcat', p, current_vmenu,"", ""); p = p+1;
		uri += build_action('append', p, current_vmenu,"comment", _cmv ); p = p+1;
		uri += build_action('append', p, current_vmenu,"alias_exten", _ae.value); p = p+1;
		if(_ae.value.length > 0){
			// alias for this voicemenu in [default] section of extensions.conf
			var alias_string = _ae.value + ",1,Goto(" + current_vmenu + "|s|1)"  ;
			uri += build_action('append', p, specialcontext ,"exten", alias_string ); p = p+1;
		}

		if( _ale.checked){ uri += build_action('append', p, current_vmenu,"include", "default"); p = p+1; }
		uri += build_action('append', p, current_vmenu,"exten", answer_call_string); p = p+1;
	}else{
		// Updating existing Voicemenu
		var current_vmenu = _vms.value;
		if(  voicemenusdata[current_vmenu].comment != _cmv ){
			uri += build_action('update', p, current_vmenu ,"comment", _cmv); p = p+1;
			change_vmenuname_inlistofmenus(voicemenusdata[current_vmenu].comment,_cmv);
			voicemenusdata[current_vmenu].comment = _cmv;
		}
		
		if(  voicemenusdata[current_vmenu].alias_exten != _ae.value ){
			var existing_alias_string = voicemenusdata[current_vmenu].alias_exten + ",1,Goto(" + current_vmenu + "|s|1)"  ;
			if( _ae.value.length > 0 ){
				// change alias for this voicemenu in 'default' section of extensions.conf
				var new_alias_string = _ae.value + ",1,Goto(" + current_vmenu + "|s|1)"  ;
				uri += build_action('update', p, specialcontext ,"exten", new_alias_string,existing_alias_string); p = p+1;
			}else{
				// if the user is deleting the alias for this voicemenu, then delete the defined alias in the [default] extensions.conf
				uri += build_action('delete', p, specialcontext ,"exten", "",existing_alias_string); p = p+1;
			}

			uri += build_action('update', p, current_vmenu ,"alias_exten", _ae.value ); p = p+1;
			voicemenusdata[current_vmenu].alias_exten = _ae.value;
		}
		
		if( voicemenusdata[current_vmenu].include =="default" && !_ale.checked ){
			uri += build_action('delete', p, current_vmenu ,"include",""); p = p+1;
			voicemenusdata[current_vmenu].include = "" ;
		}else if ( voicemenusdata[current_vmenu].include !="default"  && _ale.checked ){
			uri += build_action('append', p, current_vmenu,"include", "default"); p = p+1;
			voicemenusdata[current_vmenu].include = "default" ;
		}else if ( !voicemenusdata[current_vmenu].include && _ale.checked ){
			uri += build_action('append', p, current_vmenu ,"include", "default"); p = p+1;
			voicemenusdata[current_vmenu].include = "default" ;
		}

		for (var k=0; k< keys.length; k++){
			if(voicemenusdata[current_vmenu].extensions[keys[k]]){
				uri += build_action('delete', p, current_vmenu,"exten", "", voicemenusdata[current_vmenu].extensions[keys[k]][0] ); p = p+1;
			}
		}
	}

	// Build exten strings for enabled keys and append/update the 
	for (var k=0; k< keys.length; k++){
		var current_key_action='keypress_'+ keys[k] + '_action';
		var current_key_text='keypress_'+ keys[k] + '_text';
		var current_key_exts='keypress_'+ keys[k] + '_exts';
		var current_key_menus='keypress_'+ keys[k] + '_menus';
	
		if( $(current_key_action).value == "disabled")
			continue;
		else if( $(current_key_action).value == "gotomenu" )
				buildstring[keys[k]] = keys[k] + ",1,Goto("+ $(current_key_menus).value + "|s|1)" ;					
		else if( $(current_key_action).value == "gotoextension" )
				buildstring[keys[k]] = keys[k] + ",1,Goto(default|"+ $(current_key_exts).value + "|1)" ;					
		else if( $(current_key_action).value == "Custom" ) 
				buildstring[keys[k]] = keys[k] + ",1,"+ $(current_key_text).value ;
		else if( $(current_key_action).value == "Hangup" )
				buildstring[keys[k]] = keys[k] + ",1,"+ "Hangup" ;					
		else if( $(current_key_action).value == "PlayInvalid" ) 
				buildstring[keys[k]] = keys[k] + ",1,"+ "Playback(invalid)" ;
					
		uri += build_action('append', p, current_vmenu,"exten", buildstring[keys[k]]); p = p+1;
	}

	makerequest('u','extensions.conf', uri ,
		function(t){
			setTimeout( function(){_$('status_message').style.display="none"; },sc_displaytime );
			gui_feedback('Updated.','blue');
			_$('savevmenu').disabled = true;
			_$('save').disabled = true;
			_$('cancel').disabled = true;
			
			if( _vms.options[_vms.selectedIndex].innerHTML=='New Entry' ){ // (if new Voicemenu 
				voicemenusdata[current_vmenu] = new Object();	
				voicemenusdata[current_vmenu].comment =  _cmv ;
				voicemenusdata[current_vmenu].alias_exten =  _ae.value;
				voicemenusdata[current_vmenu].extensions = new Object();
				// add the "s,1,Answer" data to voicemenus data
				voicemenusdata[current_vmenu].extensions['s'] = new Array();
				voicemenusdata[current_vmenu].extensions['s'][0] = answer_call_string;
				for (var k=0; k< keys.length; k++){
					if( buildstring[keys[k]] ){
						voicemenusdata[current_vmenu].extensions[keys[k]] = new Array();
						voicemenusdata[current_vmenu].extensions[keys[k]][0] = buildstring[keys[k]] ;
					}
				}
				// update vmenus
				_vms.options[_vms.selectedIndex].text = "VoiceMenu - " + _cmv;
				_vms.options[_vms.selectedIndex].value = current_vmenu;
				select_vmenu();
				// add the new menu to the list of menus being displayed in the keypad options
				add_newvmenu_tolistofkeymenus();

			}else{ // if editing existing keypress options
				for (var k=0; k< keys.length; k++){
					if( buildstring[keys[k]] ){
						voicemenusdata[current_vmenu].extensions[keys[k]] = new Array();
						voicemenusdata[current_vmenu].extensions[keys[k]][0] = buildstring[keys[k]] ;
					}else{
						if( voicemenusdata[current_vmenu].extensions[keys[k]] ){
							voicemenusdata[current_vmenu].extensions[keys[k]] = [];
						}
					}
				}
			}
		}
	);
}


function  enable_savecancel(){
	_$('save').disabled=false;
	_$('savevmenu').disabled = false;
	_$('cancel').disabled = false;
}


function generate_fields(key){
	var t = '<select  class="input8" style="font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"   id=\'keypress_'+ key + '_action\' onchange="key_action(this.value, \'' + key + '\')">\n';
	t += '<option value="disabled">Disabled</option>\n' ;
	t += '<option value="gotomenu">Goto Menu</option>\n';
	t += '<option value="gotoextension">Goto Extension</option>\n';
//	t += '<option value="Custom">Custom</option>\n';
	t += '<option value="Hangup">Hangup</option>\n';
	t += '<option value="PlayInvalid">Play Invalid</option>\n';
	t += '</select>&nbsp;<input type="text" class="input8" size=16 style="display:none;font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;" id="keypress_' + key+ '_text" onchange="enable_savecancel()">\n';
	t += '<select  style="display:none; font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"  id="keypress_'+ key + '_menus" onchange="enable_savecancel()" class="input8"></select>\n';
	t += '<select  style="display:none; font-family: Verdana, Arial, Helvetica, Sans-Serif;font-size: 11px;"  id="keypress_'+ key + '_exts" onchange="enable_savecancel()" class="input8"></select>\n';
	return t;
}

function step_onselect(){
	// enable delete button
	if(_$('steps').value){
		_$('deletestep').disabled = false;
	}

	// enable Up/Down buttons accordingly
	update_updown();
}

function update_updown(){
	var _steps = _$('steps') ;
	_$('stepUp').disabled =( _steps.selectedIndex ) ? false : true ; 
	_$('stepDown').disabled = ( _steps.selectedIndex != (_steps.length-1) ) ? false: true ;
}

function step_up(){ // Swap x, x-1
	var _steps = _$('steps') ; 
	swap_step(_steps.selectedIndex, _steps.selectedIndex-1 );
}


function step_down(){	//swap x, x+1
	var _steps = _$('steps') ;
	swap_step( _steps.selectedIndex, _steps.selectedIndex+1 );
}


function swap_step(a,b){
	var _steps = _$('steps');
	var _vms_v = _$('vmenus').value ;

	var tmp1 = _steps.options[a].value.split(",") ;
	var step1_action = tmp1.slice(2).join(",");

	var tmp2 = _steps.options[b].value.split(",") ;
	var step2_action = tmp2.slice(2).join(",");

	var new_step1 = tmp1[0] + ","+ tmp1[1] + "," + step2_action;
	var new_step2 = tmp2[0] + ","+ tmp2[1] + "," + step1_action;

	var uri = "";
	uri += build_action('update', 0, _vms_v ,"exten","BUFFERBUFFERBUFFER", _steps.options[a].value);
	uri += build_action('update', 1, _vms_v ,"exten",new_step2, _steps.options[b].value);
	uri += build_action('update', 2, _vms_v ,"exten",new_step1, "BUFFERBUFFERBUFFER");
	// we need a buffer update other wise you end up updating the just updated value 
	// note that rawman actions are executed sequentially.

	makerequest('u','extensions.conf', uri,
		function(t){
			// update voicemenusdata
			for(var p=0; p< voicemenusdata[_vms_v].extensions['s'].length; p++){
				if( voicemenusdata[_vms_v].extensions['s'][p] == _steps.options[a].value ){
					voicemenusdata[_vms_v].extensions['s'][p] = new_step1;
				}else if (voicemenusdata[_vms_v].extensions['s'][p] == _steps.options[b].value  ){ 
					voicemenusdata[_vms_v].extensions['s'][p] = new_step2;
				}
			}
			// swap select values of a to b
			_steps.options[a].value = new_step1;
			_steps.options[b].value = new_step2;
			var buffer = _steps.options[a].text;
			_steps.options[a].text = _steps.options[b].text;
			_steps.options[b].text = buffer;
			_steps.selectedIndex = b;
			gui_feedback('Step Priority Updated!','blue');
			update_updown();
		}
	);
}


function delete_step(){
	// delete the selected step and update voicemenusdata and update 'select' object - steps
	_$('status_message').style.display="";
	var _vmenus = _$('vmenus');
	var _steps = _$('steps');
	var uri = "";
	uri += build_action('delete', 0, _vmenus.value,"exten", "", _steps.value); 
	
	var v = _steps.selectedIndex;
	if(v==0 && _steps.options[1] ){ // if deleting the first step, then make priority of 2nd step to '1'
		var tmp2 = _steps.options[1].value.split(",") ;
		var step2_action = tmp2.slice(2).join(",");
		var new_step1 = tmp2[0] + ",1," + step2_action;
		uri += build_action('update',1,_vmenus.value,"exten",new_step1,_steps.options[1].value);
	}

	makerequest('u','extensions.conf', uri,
		function(t){
			setTimeout(function(){ _$('status_message').style.display='none';} ,sc_displaytime);
			// Update voicemenusdata
			for(var p=0; p< voicemenusdata[_vmenus.value].extensions['s'].length; p++){
				if( voicemenusdata[_vmenus.value].extensions['s'][p] == _steps.value ){ 
					if(new_step1){
						voicemenusdata[_vmenus.value].extensions['s'].splice(p,2, new_step1);
					}else{
						voicemenusdata[_vmenus.value].extensions['s'].splice(p,1);
					}
				}
			}
			//update_stepsbelow
			_steps.remove( _steps.selectedIndex);
			if(new_step1){ _steps.options[0].value = new_step1; }
			gui_feedback('Step Deleted !','default');
			_$('deletestep').disabled = true;
		}
	);

}


function update_newstep_var(){
	var _nsv = _$('newstep_var') ;
	var _nsa = _$('newstep_action');
	var _ane = _$('add_newstep_extensions') ;
	var _anm = _$('add_newstep_menus') ;
	var _nss = _$('newstep_sounds');

	_nsv.value = "";
	_nsv.style.display = "none";
	_$('newstep_var_digit').style.display= "none" ;
	_ane.style.display = "none";
	_anm.style.display = "none";
	//_$('tbr').style.display = "none";
	_$('rgrp').style.display = "none";
	_nss.style.display = "none";
	_nss.value = "";

        if( _nsa.value== "" || _nsa.value== "Answer"  || _nsa.value== "Hangup" || _nsa.value== "GotoDirecotry" || _nsa.value== "Busy" || _nsa.value== "Congestion" ){

        }else if( _nsa.value== "Background"  || _nsa.value== "Playback" ){
                _nss.style.display = "";
        }else if( _nsa.value== "Authenticate"  || _nsa.value== "DigitTimeout"  || _nsa.value== "ResponseTimeout" ||  _nsa.value== "Wait"  ||  _nsa.value== "WaitExten"  || _nsa.value== "DISA"){
                _$('newstep_var_digit').style.display= "" ;
        }else if(_nsa.value== "GotoMenu"  ){
		_nsv.value = _anm.value;
		_anm.style.display = "";
        }else if(_nsa.value== "GotoExtension"  ){
		_nsv.value = _ane.value;
		_ane.style.display = "";
        }else if(_nsa.value== "GotoTimeBasedRule"  ){
		//_$('tbr').selectedIndex = -1;
		//_$('tbr').style.display = "";
        }else if(_nsa.value== "DialRingGroup"  ){
		_$('rgrp').selectedIndex = -1;
		_$('rgrp').style.display = "";
        }


}


function select_vmenu(){
	// show all the //s, lines in the select box -
	if(_$('vmenus').selectedIndex ==-1){ return true;}

	var _steps = _$('steps');
	current_context = _$('vmenus').value;
	var x, y, tmp;
	var priority_1, priority_2, buffer;
	
	_$('allowexten').checked = (voicemenusdata[current_context].include == "default") ? true : false ;
 	//$('keypressoptions').innerHTML = "";
	_steps.options.length =0;
	_$('comment').value = voicemenusdata[current_context].comment;
	_$('alias_exten').disabled = false;
 	_$('alias_exten').value = ( voicemenusdata[current_context].alias_exten  ) ? voicemenusdata[current_context].alias_exten : "" ;

	if(voicemenusdata[current_context].extensions['s']){
		for (var x=0;x<voicemenusdata[current_context].extensions['s'].length ; x++ ){
			var newoption = document.createElement("option");
			newoption.text = format_step(voicemenusdata[current_context].extensions['s'][x]);
			newoption.value = voicemenusdata[current_context].extensions['s'][x];
			_steps.options.add ( newoption );
		}
	}

	// To be done: replace the following bubble sort with js native sort method
	for (var x = (_steps.length - 1); x >= 0; x--){
		for (var y = 1; y <= x; y++){
			tmp = _steps.options[y].value.split(",") ;
			priority_1 = tmp[1];
			tmp = _steps.options[y-1].value.split(",") ;
			priority_2 = tmp[1];
			if (priority_2 - priority_1 > 0){
				buffer = _steps.options[y-1].value;
				_steps.options[y-1].value = _steps.options[y].value;
				_steps.options[y].value = buffer;
				buffer = _steps.options[y-1].text;
				_steps.options[y-1].text = _steps.options[y].text;
				_steps.options[y].text = buffer;
			}
		}
	}

	_steps.disabled = false;
	_$('b_ShowAddStep').disabled = false;
	_$('addstep').disabled = false;
	_$('allowexten').disabled = false;
	_$('comment').disabled = false;
	_$('deletestep').disabled = true;
	_$('delete').disabled = false;
	_$('newstep_action').disabled = false;
	_$('newstep_sounds').disabled = false;
	_$('newstep_var').disabled = false;
	_$('keypressoptions').style.display = "";
	_$('stepDown').disabled = true;
	_$('stepUp').disabled = true;
	_$('savevmenu').disabled = true;

	for (y=0; y<keys.length ; y++ ){
		current_key_action='keypress_'+ keys[y] + '_action';
		current_key_text='keypress_'+ keys[y] + '_text';
		current_key_exts='keypress_'+ keys[y] + '_exts';
		current_key_menus='keypress_'+ keys[y] + '_menus';

		_$(current_key_action).options.selectedIndex = 0;
		_$(current_key_menus).style.display = "none";
		_$(current_key_text).style.display = "none";
		_$(current_key_exts).style.display = "none";

		if(voicemenusdata[current_context].extensions[keys[y]]){
			// Load the appropriate Key menu according to the voicemenusdata[current_context].extensions[y][x]
			// actually we are assuming that there is only voicemenusdata[current_context].extensions[y][0]
			tmp = voicemenusdata[current_context].extensions[keys[y]][0].split(',');

			if( tmp[2].match("Goto") && tmp[2].match("voicemenu-") ){ //  if "is a voicemenu"
				_$(current_key_action).options[1].selected = true;
				_$(current_key_menus).style.display = "";
				select_menu (current_key_menus, tmp[2],"ismenu");
			}else  if( tmp[2].match("Goto") && !tmp[2].match("voicemenu-") ){ // //  if "goto an extension " (no 'voicemenu-')
				_$(current_key_action).options[2].selected = true;
				_$(current_key_exts).style.display = "";
				select_menu(current_key_exts, tmp[2],"isext"); // select_menu common for exts and menus
			}else if(tmp[2].match("Hangup") ){ // if HangUp
				ASTGUI.selectbox.selectOption(_$(current_key_action), 'Hangup'); //
			}else if( tmp[2].match('Playback') &&  tmp[2].match( "(invalid)" ) ){
				ASTGUI.selectbox.selectOption(_$(current_key_action), 'PlayInvalid');
			}else{ // if custom (no 'goto')
				_$(current_key_action).options[3].selected = true;
				_$(current_key_text).style.display = "";
				_$(current_key_text).value = tmp[2];
			}
		}else{	// Key_action is disabled => hide the text & options (which already are)

		}
	}
}


menuscallbacks.postselect = function() {
	select_vmenu();
}

menuscallbacks.format = function(t, x) {
	var tmp = t.name.split('general');
	var exten_fields;

	if(tmp.length > 1 ){
		return false;
	}else if ( t.name.substr(0,10) == 'voicemenu-' && x==undefined ){	// if is a category
		current_context = t.name;
		voicemenusdata[current_context] = new Object();
		return t.name ;
	}else if(t.name.substr(0,10) == 'voicemenu-' ) { 	// if is a subcategory
		switch( t.names[x] ){
			case 'comment':
				voicemenusdata[current_context].comment =  t.fields[x];
				voicemenusdata[current_context].extensions = new Object();
				return false;
			case 'alias_exten':
				voicemenusdata[current_context].alias_exten =  t.fields[x];
				return false;
			case 'include':
				voicemenusdata[current_context].include=  t.fields[x];
				return false;
			case 'exten':
				exten_fields = t.fields[x].split (',');
				if(!voicemenusdata[current_context].extensions[exten_fields[0]]){
					voicemenusdata[current_context].extensions[exten_fields[0]] = new Array();
				}
				voicemenusdata[current_context].extensions[exten_fields[0]].push( t.fields[x] ) ;
				return false;
			default :
				return false;
		}
		return false;
	}else{
		return false;
	}
}


menuscallbacks.loaded = function(){
	var _vmenus = _$('vmenus') ;
	for (var x=0; x< _vmenus.options.length ; x++ ){
		_vmenus.options[x].text = "VoiceMenu - " + voicemenusdata[_vmenus.options[x].value].comment;
	}
	// Load the menus and extensions into corresponding fields
	for (var y=0;y < keys.length; y++){
		current_key_exts='keypress_'+ keys[y] + '_exts';
		current_key_menus='keypress_'+ keys[y] + '_menus';
		load_extensions(current_key_exts);
		load_menus(current_key_menus);
	}
	load_extensions('add_newstep_extensions');
	load_menus('add_newstep_menus');
	parent.loadscreen(this);
}

menuscallbacks.identifier = "extension";

menuscallbacks.eachline = true;

menuscallbacks.includecats = true;

menuscallbacks.cancelnewcategory =function(){
	_$('comment').disabled = true;
	_$('keypressoptions').style.display = "none";
}

menuscallbacks.oncategorydelete =function(){
	delete_vmenu_fromlistofmenus();
	_$('comment').disabled = true;
	_$('keypressoptions').style.display = "none";
	_$('savevmenu').disabled = true;
	_$('steps').options.length =0;
	_$('newstep_action').disabled = true;
	_$('newstep_var').disabled = true;
	_$('newstep_sounds').disabled = true;
	_$('addstep').disabled = true;
	_$('b_ShowAddStep').disabled = true;
	_$('steps').disabled = true;
	_$('stepUp').disabled = true;
	_$('stepDown').disabled = true;
	_$('alias_exten').value = "";
	_$('alias_exten').disabled = true;
}

menuscallbacks.cancelchanges =function(){
	_$('savevmenu').disabled = true;
}

menuscallbacks.newcategory = function(t) {
	// 1. Reset all Keyoptions
	// Load the menus and extensions into corresponding fields
	for (var y=0;y<keys.length; y++){
		current_key_exts='keypress_'+ keys[y] + '_exts';
		current_key_menus='keypress_'+ keys[y] + '_menus';
		current_key_text = 'keypress_'+ keys[y] + '_text' ;
		current_key_action='keypress_'+ keys[y] + '_action';
	
		load_extensions(current_key_exts);
		load_menus(current_key_menus);
		_$(current_key_action).selectedIndex = 0;
		_$(current_key_exts).style.display = "none";
		_$(current_key_menus).style.display = "none";
		_$(current_key_text).style.display = "none";
	}
	// 2. Reset Steps - only 1 step -> Answer
	var _steps = _$('steps') ;
	var _comment = _$('comment'); 
	var _allowexten = _$('allowexten') ;
	var _alias_exten = _$('alias_exten') ;
	_steps.options.length =0;
	var newoption = document.createElement("option");
	newoption.text = format_step(answer_call_string);
	newoption.value = answer_call_string;
	_steps.options.add ( newoption );
	// 3. Disable Steps - Add Step , Up , Down Arrows
	_$('stepUp').disabled = true;
	_$('stepDown').disabled = true;
	_allowexten.checked = false;
	_allowexten.disabled = false;
	_$('newstep_action').disabled = true;
	_$('newstep_var').disabled = true;
	_$('newstep_sounds').disabled = true;
	_$('addstep').disabled = true;
	_$('b_ShowAddStep').disabled = true;
	_steps.disabled = true;
	//  4. Reset Comment
	_$('keypressoptions').style.display = "";
	_alias_exten.disabled = false;
	_alias_exten.value = "";
	_comment.disabled = false;
	_comment.value = "";
	_comment.focus();
}


function localajaxinit() {
	parent._$('mainscreen').width= 798;
	ASTGUI.events.add(document, 'mouseover', show_tooltip);
	showdiv_statusmessage();
	setWindowTitle("Voice Menus");
	_$('message_text').innerHTML ="Saving Changes...";
	for (x =0 ; x<fieldnames.length; x++){
		widgets[fieldnames[x]] = _$(fieldnames[x]);
		widgets[fieldnames[x]].disabled = true;
	}
	//parent.loadscreen(this);
	parent.astmanEngine.config2list("extensions.conf", _$('extensions'), new Array(), extencallbacks);
}

//extencallbacks
extencallbacks.format = function(t, x) {
	var res;
	var qname;

	if(t.name == TIMERULES_CATEGORY && t.fields[x].match("NoOp") ){
		return null ; // disable time based rules
		var m = t.fields[x].split('NoOp')[1].substr(1);
		m = m.substr(0, m.length-1);
		
		var l = document.createElement('option');
			l.text = m ;
			l.value = TIMERULES_CATEGORY + ","+ t.fields[x].split(',')[0] + ",1" ;
		
		if(document.attachEvent){ 
			//_$('tbr').add(l);
		}else{
			//_$('tbr').add(l,null);
		}
		return null ;
	}
	

	if( t.name.match('ringroups-custom-') && !x ){
		var k = t.fieldbyname['gui_ring_groupname'];
		var l = document.createElement('option');
			l.text = (k)?k:t.name;
			l.value = t.name + ",s,1" ;
		
		if(document.attachEvent){ 
			_$('rgrp').add(l);
		}else{
			_$('rgrp').add(l,null);
		}
		return null;
	}


	if ((t.name != specialcontext))
	return null;

	// check whether the extension is an alias to a custom voice menu
	try{
		var temp = t.fields[x].split(',') ;
		if ( temp[2].match("Goto") && temp[2].match("voicemenu-custom-" )  ){ return null ; }
	}
	catch(e){

	}

	res = format_extension(_$('extensions'), t, x);
	return res;
}

extencallbacks.loaded = function() {
	parent.astmanEngine.run_tool(asterisk_guiListFiles + " " + asterisk_Sounds_path, callback = function() { 
	var opt = { method: 'get', asynchronous: true,
		onComplete: function(originalRequest){
			var sndfiles = originalRequest.responseText.split("\n") ;
			var file_name;
			var listof_DefaultSounds = {};
			for( var i =0 ; i < sndfiles.length ; i++){
				if( typeof sndfiles[i] == "undefined"  || sndfiles[i] == "" ){
					continue;
				}
				sndfiles[i] = sndfiles[i].replace(/^\s*|\s*$/g,'') ;
				if( sndfiles[i] == "" ){ continue; }
				file_name = sndfiles[i].stripTags() ;
				file_name = file_name.replace(/\..*/,""); /* Replace .ulaw .gsm .whatever with nothing so its just the sound file */
				listof_DefaultSounds[file_name] = true;
			}
			for(var i in listof_DefaultSounds){
				if( listof_DefaultSounds.hasOwnProperty(i) ){ 
					LISTOFSOUNDS.push(i);
				}
			}
			load_recordedfiles();
		},
		onFailure: function(t) { alert("Config Error: " + t.status + ": " + t.statusText); }
	};
	opt.parameters="";
	var tmp = new Ajax.Request(asterisk_guiSysInfo_output , opt);
	});
}


function load_recordedfiles(){
	parent.astmanEngine.run_tool(asterisk_guiListFiles + " " + asterisk_menusRecord_path, callback = function() { 
	var opt = { method: 'get', asynchronous: true,
		onComplete: function(originalRequest){
			// Add Recorded Voiemenus to the list of sound files
			var recfiles = originalRequest.responseText.split("\n") ;
			var file_name;
			for( var i =0 ; i < recfiles.length ; i++){
				if( typeof recfiles[i] == "undefined"  || recfiles[i] == "" ){
					continue;
				}
				recfiles[i] = recfiles[i].replace(/^\s*|\s*$/g,'') ;
				if( recfiles[i] == "" ){ continue; }
				file_name = recfiles[i].stripTags() ;
				file_name = file_name.substr(0,(file_name.length - 4) ) ;
				LISTOFSOUNDS.push("record/" + file_name);
			}
			ASTGUI.COMBOBOX.call(  _$('newstep_sounds') , LISTOFSOUNDS, 400 );
			parent.astmanEngine.config2list("users.conf", _$('users'), new Array(), usercallbacks);
		},
		onFailure: function(t) { alert("Config Error: " + t.status + ": " + t.statusText); }
	};
	opt.parameters="";
	var tmp = new Ajax.Request(asterisk_guiSysInfo_output , opt);
	});
}





extencallbacks.eachline = true;

// user callbacks
usercallbacks.format = function (t,x){
	if ((t.name == 'general')){
		if (t.fieldbyname['localextenlength'] && t.fieldbyname['localextenlength'].length){
			localextenlength =  t.fieldbyname['localextenlength'] ;
		}else{
			localextenlength =  4 ;
		}
		return null;
	}

	//if (t.name.substring(0,6) == 'trunk_')
	//	return null;
	if ( t.fieldbyname['context'] == asterisk_guiTDPrefix + t.name ) {
		return null;
	}else{
		return t.name;
	}
}

usercallbacks.identifier = "extension";

usercallbacks.loaded = function (){
	var _exts = _$('extensions') ;
	var _users = _$('users') ;

	for(var p=0; p < _exts.length; p++){
		var tmp = _exts.options[p].text.split (" -- ");
		extensions_array.push (tmp[0]);
	}
	for(var p=0; p < _users.length; p++){
		extensions_array.push (_users.options[p].text);
	}
	extensions_array = extensions_array.sort(); // or extensions_array.sort(sortNumber);
	parent.astmanEngine.config2list("extensions.conf", _$('vmenus'), widgets, menuscallbacks);
}

function free_mem(){
	parent._$('mainscreen').width= 540;
	if( navigator.userAgent.indexOf("MSIE") == -1 ){ return true; }
	try{
		widgets['save'].hostselectbox = null ;
		widgets['cancel'].hostselectbox = null ;
		widgets['new'].hostselectbox = null ;
		widgets['delete'].hostselectbox = null ;
		purge( document.body );
	} catch(e){ }
}

function show_addStep(){
	_$('bg_transparent').style.display="" ;
	_$('NewStep_Content').style.display="" ;
}

function hide_addStep(){
	_$('bg_transparent').style.display="none" ;
	_$('NewStep_Content').style.display="none" ;
}

</script>
<body id="foo" onload="localajaxinit()"  bgcolor="EFEFEF" onunload="free_mem()">
<div class="page_header">
	<span style="margin-left: 4px;font-weight:bold;">Voice Menus Configuration</span>
	<span style="cursor: pointer; cursor: hand;" onclick="window.location.href=window.location.href;" >&nbsp;<img src="images/refresh.png" title=" Refresh " border=0 >&nbsp;</span>
</div>
<div class="mainscreenContentBox" id="userscontent">
<table class="VoiceMenuMainTable" align="left">
	<tr valign="top">
		<td colspan='2'> Voice Menus: </td>
	</tr>
	<tr valign="top">
		<td>	<select size="25" id="vmenus" style="width:180px;" class="input10"><option>Loading...</option></select>	</td>
		<td valign=top align="right" width=560 height=415>
			<select id='extensions' style='display:none;width:0px;height:0px'></select><select id='users' style='display:none;width:0px;height:0px'></select><select id='recorded_files' style='display:none;width:0px;height:0px'></select>
			<table align="center" width="560">
			<tr>
				<td width="50" align=left class="field_text" tip="en,menus,0">Name:</td>
				<td align=left class="field_text">
					<input id='comment'  size=15 onKeyUp="enable_savecancel()"  pattern='^[a-zA-Z_0-9 ]*$' disabled  class="input8">&nbsp;
					<span tip="en,menus,5">
					Extension: <input id="alias_exten"  onKeyUp="enable_savecancel()"  size=4 disabled class="input8" tip="en,menus,5">
					</span>
					&nbsp;&nbsp;&nbsp;&nbsp;
					<label FOR="allowexten"  tip="en,menus,3">
					<input type=checkbox id=allowexten disabled onclick="enable_savecancel()"> Allow Dialing other Extensions?
					</label>
				</td>
			</tr>
			<tr>	<td class="field_text"  tip="en,menus,1">Steps:<BR>
					<input  style='width:45'  type="button" id="stepUp" value="Up" disabled onClick="step_up()" class="buttonbold"><BR><BR>
					<input  style='width:45' type="button" id="stepDown" value="Down" disabled onClick="step_down()" class="buttonbold">
				</td>
				<td><select id='steps' size=8  style="width:550px;" onClick="step_onselect()" disabled class="input8"></select></td>
			</tr>

			<tr>	<td> </td>
				<td class="field_text">
				<input type=button style='width:105' id='b_ShowAddStep' onclick="show_addStep()"  value="Add new Step" disabled  class="buttonbold">
				&nbsp;<input type=button style='width:140' id='deletestep' onclick="delete_step()"  value="Delete selected Step" disabled  class="buttonbold">
				</td>
			</tr>
			<tr>	<td colspan=2 height=25></td></tr>
			<tr><td colspan=2>
				<div>
					<table cellpadding=3 cellspacing=0 width="100%">
					<TR bgcolor='#B8B8B8'>
						<TD width=35 class="field_text">Key</TD><TD class="field_text">Action</TD>
						<TD width=440 class="field_text" tip="en,menus,4" align=center><B>'Keypress' Events</B></TD>
					</TR>
					</table>
				</div>
				<div id="keypressoptions" style="height:190px;overflow :auto;display :none;">
					<table cellpadding=3 cellspacing=0 width="100%">
					<script>
					for (var k=0; k< keys.length; k++){
						var p =  generate_fields( keys[k] )  ; 
						switch(keys[k]){
							case 't': var omo =  " tip=\"en,menus,6\" " ; break;
							case 'i': var omo =  " tip=\"en,menus,7\" " ; break;
							default: var omo =  "" ;
						}
						document.write("<TR bgcolor='#FFFFFF'>\n"
						+ "<TD width=35 align=center " + omo + "><font style=\"font-size: 10pt\">"+keys[k]+"</font></TD>\n"
						+ "<TD>" 
						+ p
						+ "\n </TD></TR>\n\n" );
					}
					</script>
					</table>
				</div>
				</td>
			</tr>
			</table>
		</td>
	</tr>
	<tr>
	<td align='center'>
		<input style='width:80' type='button' id='new' value='New' class="buttonbold">&nbsp;
		<input style='width:80' type='button' id='delete' value='Delete' class="buttonbold">&nbsp;
	</td>
	<td align='right'>
		<input type="hidden" id="save">
		<input type='button' id='savevmenu' onClick="save_vmenu()" value='Save' disabled class="buttonbold">&nbsp;
		<input type='button' id='cancel' value='Cancel' class="buttonbold">&nbsp;
	</td>
	</tr>
</table>
</div>
<div id="NewStep_Content" STYLE="display:none; position: absolute; left: 40; top: 64; width:580; height:60;  background-color:#F4EFE5;   border-width: 1px; border-color: #7E5538; border-style: solid; z-index:100">
	<table width="100%" cellpadding=0 cellspacing=0  onmousedown="ASTGUI.startDrag(event , 'NewStep_Content');">
	<TR bgcolor="#7E5538"  style="background-image:url('images/title_gradient.gif');">
		<TD tip="en,menus,2"><font color="#FFFFFF">&nbsp;&nbsp;<B>Add a new Step:</B></FONT></TD>
		<TD Height="20" align="right" style="cursor: move">
			<A href="#" onclick="hide_addStep();" style="color:#FFFFFF; font-size: 12px; font-weight:bold;">X</A>
		</TD>
		<TD width=4></TD>
	</TR>
	</table>
	<table cellpadding=2 cellspacing=2 border=0 width="100%" align="center">
	<tr>	<td colspan=2 class="field_text" align=center height=40 valign=middle>
		<NOBR>
		Add new Step: 
		<select id='newstep_action' disabled onChange="update_newstep_var()" class="input8">
			<option value=""> -- Select --</option>
			<option value="Answer">Answer</option>
			<option value="Authenticate">Authenticate</option>
			<option value="Background">Background</option>
			<option value="Busy">Busy Tone</option>
			<option value="Congestion">Congestion</option>
			<!-- <option value="SetMusicOnHold">SetMusicOnHold</option> -->
			<option value="DigitTimeout">DigitTimeout</option>
			<option value="DISA">DISA</option>
			<option value="ResponseTimeout">ResponseTimeout</option>
			<option value="Playback">Playback</option>
			<option value="Wait">Wait</option>
			<option value="WaitExten">WaitExten</option>
			<option value="GotoMenu">Goto Menu</option>
			<option value="GotoDirecotry">Goto Directory</option>
			<option value="GotoExtension">Goto Extension</option>
			<option value="GotoTimeBasedRule">Goto TimeBasedRule</option>
			<option value="DialRingGroup">Dial RingGroup</option>
			<option value="CheckOwnVoiceMail">Check Voicemail for Own Extension</option>
			<option value="Hangup">Hangup</option>
		</select>&nbsp;
		<input type=text id="newstep_var" style="display:none" size=4 disabled class="input8">
		<input type=text id="newstep_sounds" style="display:none" size=24 disabled class="input9">
		<select id='add_newstep_extensions' style="display:none" onChange=" $('newstep_var').value = $('add_newstep_extensions').value;"   class="input8"></select>
		<select id='add_newstep_menus' style="display:none" onChange=" $('newstep_var').value = $('add_newstep_menus').value;"   class="input8"></select>
		<!-- <select style="display:none" id="tbr" class="input8" onChange=" $('newstep_var').value = $('tbr').value;"></select> -->
		<select style="display:none" id="rgrp" class="input8" onChange=" $('newstep_var').value = $('rgrp').value;"></select>
		<input type=text id="newstep_var_digit" size=3 style="display:none;" onChange=" $('newstep_var').value = $('newstep_var_digit').value;"  pattern='^\d*$' class="input8">&nbsp;
		<input type=button style='width:45' id='addstep' onclick="add_newstep()"  value="Add" disabled  class="buttonbold">
		<input type=button style='width:55' onclick="hide_addStep()"  value="Cancel" class="buttonbold">
		</NOBR>
		</td>
	</tr>
	</table>
</div>
<div id="bg_transparent" STYLE="display:none; position: absolute; left: 0; top: 24; width:100%; height:100%;  background-color:#EFEFEF; -moz-opacity:.50;opacity:.50; border-width: 1px; border-color: #EFEFEF; border-style: solid; z-index:4">
</div>
</body>
